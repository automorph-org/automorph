!function(e){"use strict";var d=Promise;if(void 0===(d=void 0===d?e.Promise:d))throw"Promise is not supported! Use latest version node/browser or promise-polyfill";function f(e){return void 0===e}function p(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}function l(e){return"function"==typeof e}function m(e){return"string"==typeof e}function h(e){if(p(e)){for(var r in e)if(e.hasOwnProperty(r))return;return 1}return g(e)?!e.length:!e}function y(e,r){if(g(e))return e.map(r);for(var n in e)e.hasOwnProperty(n)&&r(e[n])}var g=Array.isArray,v={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};function O(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}function r(){var o=this,n={},t=0,s={};function a(e,r){e=e,e=JSON.parse(JSON.stringify(e));return r&&(p(r)&&r.hasOwnProperty("message")?e.data=r.message:m(r)&&(e.data=r),r instanceof O&&(e={message:r.message,code:r.code},r.hasOwnProperty("data")&&(e.data=r.data))),e}function i(e){try{return e.error?(r=e,void(n.hasOwnProperty(r.id)?n[r.id].reject(r.error):console.log("Unknown request",r))):(r=e).hasOwnProperty("result")&&r.hasOwnProperty("id")?(r=e,void(n.hasOwnProperty(r.id)?(n[r.id].resolve(r.result),delete n[r.id]):console.log("unknown request",r))):e.method?function(r){{if(!s.hasOwnProperty(r.method))return d.resolve({jsonrpc:"2.0",id:r.id,error:a(v.METHOD_NOT_FOUND,{message:r.method})});try{var e;if(r.hasOwnProperty("params")){if("pass"==s[r.method].params)e=s[r.method].fn.call(s,r.params);else if(g(r.params))e=s[r.method].fn.apply(s,r.params);else if(p(r.params)){if(!(s[r.method].params instanceof Array))return d.resolve({jsonrpc:"2.0",id:r.id,error:a(v.INVALID_PARAMS,"Undeclared arguments of the method "+r.method)});var n=[];if(s[r.method].params.forEach(function(e){r.params.hasOwnProperty(e)?(n.push(r.params[e]),delete r.params[e]):n.push(void 0)}),0<Object.keys(r.params).length)return d.resolve({jsonrpc:"2.0",id:r.id,error:a(v.INVALID_PARAMS,{message:"Params: "+Object.keys(r.params).toString()+" not used"})});e=s[r.method].fn.apply(s,n)}}else e=s[r.method].fn();return r.hasOwnProperty("id")?function(e){return e&&"function"==typeof e.then}(e)?e.then(function(e){return f(e)&&(e=o.undefinedResult),{jsonrpc:"2.0",id:r.id,result:e}}).catch(function(e){return{jsonrpc:"2.0",id:r.id,error:a(v.INTERNAL_ERROR,e)}}):(f(e)&&(e=o.undefinedResult),d.resolve({jsonrpc:"2.0",id:r.id,result:e})):d.resolve()}catch(e){return d.resolve({jsonrpc:"2.0",id:r.id,error:a(v.INTERNAL_ERROR,e)})}}}(e):d.resolve({id:null,jsonrpc:"2.0",error:a(v.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),d.reject(e)}var r}function u(e,r){e={jsonrpc:"2.0",method:e,params:r};return p(r)&&!h(r)&&(e.params=r),e}function c(e,r){e={jsonrpc:"2.0",method:e,id:t+=1};return p(r)&&!h(r)&&(e.params=r),{promise:new d(function(e,r){n[t.toString()]={resolve:e,reject:r}}),message:e}}o.undefinedResult=!0,o.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},o.dispatch=function(e,r,n){if(m(e)&&"pass"==r&&l(n))s[e]={fn:n,params:r};else if(m(e)&&g(r)&&l(n))s[e]={fn:n,params:r};else{if(!(m(e)&&l(r)&&f(n)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");s[e]={fn:r,params:null}}},o.on=o.dispatch,o.off=function(e){delete s[e]},o.call=function(e,r){r=c(e,r);return o.toStream(JSON.stringify(r.message)),r.promise},o.notification=function(e,r){o.toStream(JSON.stringify(u(e,r)))},o.batch=function(e){var n=[],t=[];return y(e,function(e){var r;e.hasOwnProperty("call")?(r=c(e.call.method,e.call.params),t.push(r.message),n.push(r.promise.then(function(e){return e},function(e){return e}))):e.hasOwnProperty("notification")&&t.push(u(e.notification.method,e.notification.params))}),o.toStream(JSON.stringify(t)),d.all(n)},o.messageHandler=function(e){try{var r=JSON.parse(e);return n=[],g(r=r)?y(r,function(e){n.push(i(e))}):p(r)&&n.push(i(r)),d.all(n).then(function(e){var r=[];return y(e,function(e){f(e)||r.push(e)}),1===r.length?o.toStream(JSON.stringify(r[0])):1<r.length&&o.toStream(JSON.stringify(r)),e})}catch(e){return console.log("Error in messageHandler(): ",e),o.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:v.PARSE_ERROR})),d.reject(e)}var n},o.customException=function(e,r,n){return new O(e,r,n)}}if(O.prototype=new Error,r.connect_xhr=function(n,t){null==n&&(n="/"),"content-type"in(t=null==t?{}:t)||(t["content-type"]="application/json; charset=utf-8"),"method"in t||(t.method="POST"),"onerror"in t||(t.onerror=console.error);var o=new r;return o.toStream=function(e){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==this.readyState)try{JSON.parse(this.responseText),o.messageHandler(this.responseText)}catch(e){t.onerror(e)}},r.open(t.method,n,!0),r.setRequestHeader("Content-type",t["content-type"]),r.send(e)},o},"function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return r});else if("undefined"!=typeof module&&void 0!==module.exports)module.exports=r;else{if(void 0===e)return;e.simple_jsonrpc=r}}(this);